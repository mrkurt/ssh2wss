# HTTP/2 Migration Plan

## Rules
1. Transport Layer Changes ONLY
   - Only change the connection layer from WebSocket to H2
   - Everything above and below transport must remain identical
   - All changes must be invisible to the application logic

2. Forbidden Changes
   - NO changes to PTY handling
   - NO changes to window size handling
   - NO changes to terminal modes
   - NO changes to auth logic
   - NO changes to session management

3. Validation
   - All existing tests must pass without modification
   - All existing client behaviors must work identically
   - All existing server behaviors must work identically

## Technical Requirements
1. Bidirectional Streaming
   - H2 requires request/response bodies for streaming
   - Must use pipes to maintain duplex connection
   - Pattern needed:
     * Request body = client->server pipe
     * Response body = server->client pipe
     * Flusher for streaming response
   - This change is internal to transport layer only
   - External interfaces remain identical

## Current State
- WebSocket connection for terminal I/O
- Separate HTTP endpoint for window resize
- Simple session tracking with sync.Map
- Basic PTY management

## Key Decisions

### Server Side
1. Transport Layer Only
   - Uses: `net/http`, `golang.org/x/net/http2/h2c`
   - Replace WebSocket handler with H2C handler
   - Keep exact same data flow pattern
   - Maintain all existing interfaces

2. Terminal Streams
   - Uses: `net/http`, `io`
   - Internal transport changes:
     * Replace WebSocket with request/response streams
     * Use pipes for bidirectional flow
     * Use flusher for streaming response
   - External behavior identical:
     * Same byte stream in both directions
     * Same PTY interface
     * Same error handling
   - **Custom**: Only the stream setup/teardown with pipes

3. Window Resize
   - NO CHANGES - keep existing implementation
   - Only benefits from H2 connection reuse
   - Same exact JSON format
   - Same exact endpoint

### Client Side
1. Transport Layer Only
   - Uses: `net/http`, `golang.org/x/net/http2`
   - Replace WebSocket client with H2 client
   - Maintain identical data flow
   - **Custom**: Only the connection setup

2. Terminal I/O
   - NO CHANGES to terminal handling
   - Only change the transport underneath
   - Keep exact same data patterns
   - Keep exact same terminal modes

### Dependencies
1. Add:
   - golang.org/x/net/http2
   - golang.org/x/net/http2/h2c
   - golang.org/x/sync/errgroup

2. Remove:
   - golang.org/x/net/websocket

3. Keep (unchanged):
   - github.com/creack/pty (NO CHANGES)
   - golang.org/x/term (NO CHANGES)
   - standard library packages

## Migration Steps
1. Add H2 transport support
   - Transport layer only
   - No changes to business logic

2. Convert terminal connection
   - Only change connection type
   - Keep exact same data flow

3. Update client transport
   - Only change connection type
   - Keep exact same client interface

4. Window resize
   - NO CHANGES to logic
   - Only benefits from H2

5. Update tests
   - Only update connection layer
   - Keep all test assertions identical

6. Remove WebSocket code
   - Only after verifying identical behavior
   - Keep all interfaces unchanged

## Testing Strategy
- Verify byte-for-byte identical behavior
- No changes to test assertions
- Only update connection setup in tests
- Validate identical PTY behavior

Everything else (process isolation, privilege dropping, etc.) will be handled in a separate plan. 