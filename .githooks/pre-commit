#!/bin/bash

# Exit on error
set -e

echo "Running linting checks..."
SEMGREP_OUTPUT=$(./rules/lint.sh 2>&1)
SEMGREP_EXIT=$?

# Print the output
echo "$SEMGREP_OUTPUT"

# Check if there were any findings
if echo "$SEMGREP_OUTPUT" | grep -q "Code Findings"; then
    echo -e "\n❌ Linting checks failed!"
    echo -e "\n⚠️  IMPORTANT: All semgrep rules must be addressed before committing! ⚠️"
    echo -e "\nThese rules protect our codebase from issues. If you're seeing this error:"
    echo "1. Review and fix ALL issues reported above"
    echo "2. NEVER add '// nosemgrep' comments without explicit permission"
    echo "3. NEVER modify the rules to bypass these checks"
    echo "4. If you believe you need an exception:"
    echo "   - Document why it's necessary"
    echo "   - Get explicit approval from the team"
    echo "   - Only then can exceptions be added"
    echo -e "\nRemember: These rules catch real problems!"
    exit 1
fi

# Also fail if semgrep itself failed
if [ $SEMGREP_EXIT -ne 0 ]; then
    echo -e "\n❌ Semgrep failed to run!"
    exit 1
fi

exit 0 
