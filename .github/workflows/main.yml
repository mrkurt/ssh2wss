# WARNING: NEVER merge/inline workflows from other files into this one.
# Each workflow should be in its own file and called from here.
# This keeps the workflows modular and reusable.

name: CI

on:
  push:
    branches: [ "**" ]  # Run on all branches
  pull_request:  # Run on all PRs
  workflow_dispatch:

permissions:
  contents: write  # Needed for creating releases

jobs:
  linux-build:
    name: "🐧 Build"
    uses: ./.github/workflows/build-linux.yml

  linux-test:
    name: "🐧 Test"
    needs: linux-build
    uses: ./.github/workflows/test-linux.yml

  macos-build:
    name: "🍎 Build"
    uses: ./.github/workflows/build-macos.yml

  macos-test:
    name: "🍎 Test"
    needs: macos-build
    uses: ./.github/workflows/test-macos.yml

  windows-client-build:
    name: "🪟 Client Build"
    uses: ./.github/workflows/build-windows-client.yml

  windows-test:
    name: "🪟 Test"
    needs: windows-client-build
    uses: ./.github/workflows/test-windows.yml

  check-changes:
    name: "🔍 Check Changes"
    needs: [linux-test, macos-test, windows-test]
    uses: ./.github/workflows/check-changes.yml

  would_release:
    name: "📝 Would Release"
    needs: check-changes
    if: |
      github.ref != 'refs/heads/main' &&
      needs.check-changes.outputs.has_changes == 'true'
    uses: ./.github/workflows/would-release.yml
    with:
      release_notes: ${{ needs.check-changes.outputs.release_notes }}
      sha: ${{ github.sha }}

  release:
    name: "🚀 Release"
    needs: check-changes
    if: |
      github.ref == 'refs/heads/main' &&
      needs.check-changes.outputs.has_changes == 'true'
    permissions:
      contents: write  # Explicitly pass write permission to release workflow
    uses: ./.github/workflows/release.yml
    with:
      release_notes: ${{ needs.check-changes.outputs.release_notes }}
      sha: ${{ github.sha }} 